{% extends "base.html" %}
{% from "partials/components.html" import page_header, collapse, action_btn, table %}
{% block title %}State - Compose Farm{% endblock %}

{% block content %}
<div class="max-w-5xl">
    {{ page_header("Deployment State", "Services tracked in <code>compose-farm-state.yaml</code>") }}

    <!-- Actions -->
    <div class="flex flex-wrap gap-2 mb-6">
        {{ action_btn("Refresh from Reality", "/api/refresh") }}
    </div>

    {% include "partials/terminal.html" %}

    {% call collapse("Deployed Services (" ~ (state | length) ~ ")", checked=True) %}
        {% if state %}
            {% call table() %}
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Running On</th>
                    </tr>
                </thead>
                <tbody>
                    {% for svc, host in state.items() | sort %}
                    <tr class="hover:bg-base-300">
                        <td><a href="/service/{{ svc }}" class="link link-primary">{{ svc }}</a></td>
                        <td><code class="text-sm">{% if host is iterable and host is not string %}{{ host | join(', ') }}{% else %}{{ host }}{% endif %}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            {% endcall %}
        {% else %}
            <p class="text-base-content/60 italic">No services currently tracked in state file.</p>
        {% endif %}
    {% endcall %}

    {% call collapse("Raw State (YAML)") %}
        <div id="state-viewer" class="yaml-viewer" data-content="{{ state_content | e }}"></div>
    {% endcall %}
</div>
{% endblock %}
