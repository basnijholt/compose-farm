{% extends "base.html" %}
{% block title %}Stats - Compose Farm{% endblock %}

{% block content %}
<div class="max-w-5xl">
    <div class="mb-6">
        <h1 class="text-3xl font-bold">Stats Overview</h1>
        <p class="text-base-content/60 text-lg">Cluster status and pending operations</p>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card bg-base-100 shadow">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-base-content/60 text-sm">Total Services</h2>
                <p class="text-4xl font-bold">{{ total_services }}</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-base-content/60 text-sm">Running</h2>
                <p class="text-4xl font-bold text-success">{{ running_services }}</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-base-content/60 text-sm">Stopped</h2>
                <p class="text-4xl font-bold text-base-content/50">{{ stopped_services }}</p>
            </div>
        </div>
    </div>

    <!-- Terminal (collapsed by default, expands on action) -->
    <div id="terminal-section" class="collapse collapse-arrow bg-base-100 shadow mb-4">
        <input type="checkbox" id="terminal-toggle" />
        <div class="collapse-title font-medium">Terminal Output</div>
        <div class="collapse-content">
            <div id="terminal-container" class="bg-[#0d1117] rounded-lg p-3 min-h-[200px] border border-white/10">
                <div id="terminal-output"></div>
            </div>
        </div>
    </div>

    <!-- Pending Operations -->
    {% if orphaned or migrations or not_started %}
    <div class="collapse collapse-arrow bg-base-100 shadow mb-4">
        <input type="checkbox" checked />
        <div class="collapse-title font-medium">Pending Operations</div>
        <div class="collapse-content">
            {% if orphaned %}
            <h4 class="font-semibold mt-2 mb-1">Orphaned Services (will be stopped)</h4>
            <ul class="list-disc list-inside mb-4">
                {% for svc, host in orphaned.items() %}
                <li><span class="badge badge-warning">{{ svc }}</span> on {{ host }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if migrations %}
            <h4 class="font-semibold mt-2 mb-1">Services Needing Migration</h4>
            <ul class="list-disc list-inside mb-4">
                {% for svc in migrations %}
                <li><span class="badge badge-info">{{ svc }}</span></li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if not_started %}
            <h4 class="font-semibold mt-2 mb-1">Services Not Started</h4>
            <ul class="list-disc list-inside mb-4">
                {% for svc in not_started %}
                <li><span class="badge badge-ghost">{{ svc }}</span></li>
                {% endfor %}
            </ul>
            {% endif %}

            <button hx-post="/api/apply"
                    hx-swap="none"
                    class="btn btn-primary mt-4">
                Apply All Changes
            </button>
        </div>
    </div>
    {% else %}
    <div role="alert" class="alert alert-success mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>All services are in sync with configuration.</span>
    </div>
    {% endif %}

    <!-- Services by Host -->
    <div class="collapse collapse-arrow bg-base-100 shadow mb-4">
        <input type="checkbox" checked />
        <div class="collapse-title font-medium">Services by Host</div>
        <div class="collapse-content">
            {% for host_name, services in services_by_host.items() | sort %}
            <h4 class="font-semibold mt-3 mb-1">
                {{ host_name }}
                {% if host_name in hosts %}
                <code class="text-xs ml-2 opacity-60">{{ hosts[host_name].address }}</code>
                {% endif %}
            </h4>
            <ul class="menu menu-horizontal bg-base-200 rounded-box mb-2">
                {% for svc in services | sort %}
                <li><a href="/service/{{ svc }}">{{ svc }}</a></li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-base-content/60 italic">No services currently running.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful && evt.detail.xhr && evt.detail.xhr.responseText) {
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.task_id) {
                    // Expand terminal section
                    const toggle = document.getElementById('terminal-toggle');
                    if (toggle) toggle.checked = true;

                    // Scroll to terminal
                    const section = document.getElementById('terminal-section');
                    if (section) section.scrollIntoView({ behavior: 'smooth' });

                    // Initialize terminal
                    initTerminal('terminal-output', response.task_id);
                }
            } catch (e) {}
        }
    });
</script>
{% endblock %}
