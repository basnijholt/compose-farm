{% extends "base.html" %}
{% from "partials/components.html" import page_header, action_btn %}
{% from "partials/icons.html" import refresh_cw, box %}
{% block title %}Containers - Compose Farm{% endblock %}

{% block content %}
<div class="max-w-7xl">
    {{ page_header("Containers", "All running containers across hosts") }}

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-2 mb-6">
        <button id="refresh-table-btn" class="btn btn-outline">
            {{ refresh_cw() }} Refresh
        </button>
        <button id="check-all-tags-btn" class="btn btn-outline">
            {{ box() }} Check All Tags
        </button>
    </div>

    <!-- Loading indicator -->
    <div id="loading-indicator" class="flex items-center gap-2 mb-4">
        <span class="loading loading-spinner loading-sm"></span>
        <span class="text-base-content/60">Loading containers...</span>
    </div>

    <!-- Container Table -->
    <div class="card bg-base-100 shadow">
        <div class="card-body p-0">
            <div id="containers-table"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Tabulator -->
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6/dist/css/tabulator_semanticui.min.css" rel="stylesheet" data-vendor="tabulator.css">
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6/dist/js/tabulator.min.js" data-vendor="tabulator.js"></script>

<style>
/* Tabulator DaisyUI theme overrides */
.tabulator {
    background-color: transparent;
    border: none;
    font-family: inherit;
}

.tabulator .tabulator-header {
    background-color: oklch(var(--b2));
    border-bottom: 1px solid oklch(var(--b3));
}

.tabulator .tabulator-header .tabulator-col {
    background-color: transparent;
    border-right: none;
}

.tabulator .tabulator-header .tabulator-col-content {
    padding: 0.75rem 1rem;
}

.tabulator .tabulator-header .tabulator-col-title {
    font-weight: 600;
    color: oklch(var(--bc));
}

.tabulator .tabulator-tableholder .tabulator-table .tabulator-row {
    background-color: transparent;
    border-bottom: 1px solid oklch(var(--b3) / 0.5);
}

.tabulator .tabulator-tableholder .tabulator-table .tabulator-row:nth-child(even) {
    background-color: oklch(var(--b2) / 0.3);
}

.tabulator .tabulator-tableholder .tabulator-table .tabulator-row:hover {
    background-color: oklch(var(--b3) / 0.5);
}

.tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell {
    border-right: none;
    padding: 0.5rem 1rem;
    color: oklch(var(--bc));
}

.tabulator .tabulator-footer {
    background-color: oklch(var(--b2));
    border-top: 1px solid oklch(var(--b3));
    padding: 0.5rem 1rem;
}

.tabulator .tabulator-footer .tabulator-page {
    @apply btn btn-sm btn-ghost;
}

.tabulator .tabulator-footer .tabulator-page.active {
    @apply btn-primary;
}

/* Custom progress bar styling */
.tabulator .tabulator-cell .progress-bar {
    width: 100%;
    height: 8px;
    background-color: oklch(var(--b3));
    border-radius: 4px;
    overflow: hidden;
}

.tabulator .tabulator-cell .progress-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.tabulator .tabulator-cell .progress-bar-fill.low { background-color: oklch(var(--su)); }
.tabulator .tabulator-cell .progress-bar-fill.medium { background-color: oklch(var(--wa)); }
.tabulator .tabulator-cell .progress-bar-fill.high { background-color: oklch(var(--er)); }

/* Status badges */
.status-badge {
    @apply badge badge-sm;
}
.status-badge.running { @apply badge-success; }
.status-badge.exited { @apply badge-error; }
.status-badge.created { @apply badge-warning; }
.status-badge.paused { @apply badge-info; }
.status-badge.restarting { @apply badge-warning; }
</style>

<script>
(function() {
    const tableEl = document.getElementById('containers-table');
    const loadingEl = document.getElementById('loading-indicator');
    const refreshBtn = document.getElementById('refresh-table-btn');
    const checkAllBtn = document.getElementById('check-all-tags-btn');
    let table = null;

    // Custom formatter: Progress bar with color coding
    function progressFormatter(cell, formatterParams) {
        const value = cell.getValue();
        if (value === undefined || value === null) return "-";

        const percent = Math.min(Math.max(value, 0), 100);
        const level = percent > 80 ? 'high' : percent > 50 ? 'medium' : 'low';

        return `<div class="flex items-center gap-2">
            <div class="progress-bar flex-1">
                <div class="progress-bar-fill ${level}" style="width: ${percent}%"></div>
            </div>
            <span class="text-xs w-12 text-right">${percent.toFixed(1)}%</span>
        </div>`;
    }

    // Custom formatter: Status badge
    function statusFormatter(cell) {
        const status = cell.getValue() || 'unknown';
        const statusLower = status.toLowerCase();
        return `<span class="status-badge ${statusLower}">${status}</span>`;
    }

    // Custom formatter: Stack link
    function stackFormatter(cell) {
        const stack = cell.getValue();
        return `<a href="/stack/${stack}" class="link link-hover font-medium">${stack}</a>`;
    }

    // Custom formatter: Code text
    function codeFormatter(cell) {
        const value = cell.getValue();
        return value ? `<code class="text-xs bg-base-200 px-1 rounded">${value}</code>` : '-';
    }

    // Custom formatter: Check tags button
    function tagsFormatter(cell) {
        const data = cell.getRow().getData();
        return `<button class="btn btn-xs btn-ghost check-tags-btn"
                        data-stack="${data.stack}" data-service="${data.service}">Check</button>`;
    }

    // Custom formatter: Memory usage with bar
    function memoryFormatter(cell) {
        const row = cell.getRow().getData();
        const usage = row.memory_usage;
        const percent = row.memory_percent;

        if (!usage) return "-";

        const level = percent > 80 ? 'high' : percent > 50 ? 'medium' : 'low';
        return `<div class="flex items-center gap-2">
            <div class="progress-bar w-16">
                <div class="progress-bar-fill ${level}" style="width: ${Math.min(percent, 100)}%"></div>
            </div>
            <span class="text-xs">${usage}</span>
        </div>`;
    }

    // Initialize Tabulator
    function initTable() {
        table = new Tabulator(tableEl, {
            layout: "fitDataFill",
            responsiveLayout: "collapse",
            pagination: true,
            paginationSize: 25,
            paginationSizeSelector: [10, 25, 50, 100],
            placeholder: "Loading containers...",
            columns: [
                { title: "Stack", field: "stack", formatter: stackFormatter, headerFilter: "input", minWidth: 120 },
                { title: "Service", field: "service", headerFilter: "input", minWidth: 120 },
                { title: "Host", field: "host", headerFilter: "input", minWidth: 80 },
                { title: "Image", field: "image", formatter: codeFormatter, minWidth: 150 },
                { title: "Tag", field: "tag", formatter: codeFormatter, minWidth: 80 },
                { title: "Status", field: "status", formatter: statusFormatter, headerFilter: "input", hozAlign: "center", minWidth: 90 },
                { title: "Uptime", field: "uptime", minWidth: 100 },
                { title: "CPU", field: "cpu_percent", formatter: progressFormatter, hozAlign: "center", minWidth: 130,
                  sorter: "number", headerTooltip: "CPU Usage %" },
                { title: "Memory", field: "memory_percent", formatter: memoryFormatter, minWidth: 180,
                  sorter: "number", headerTooltip: "Memory Usage" },
                { title: "Net I/O", field: "net_io", minWidth: 120, formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? `<span class="text-xs">${value}</span>` : '-';
                }},
                { title: "Tags", field: "tags", formatter: tagsFormatter, headerSort: false, minWidth: 80, hozAlign: "center" },
            ],
            initialSort: [{ column: "stack", dir: "asc" }],
        });

        // Handle check tags button clicks
        tableEl.addEventListener('click', handleCheckClick);
    }

    // Load all data at once (faster than streaming for Tabulator)
    async function loadData() {
        loadingEl.style.display = 'flex';
        loadingEl.innerHTML = '<span class="loading loading-spinner loading-sm"></span>' +
            '<span class="text-base-content/60">Loading containers...</span>';

        try {
            const resp = await fetch('/api/containers');
            const json = await resp.json();

            // Initialize table with all data at once
            if (!table) {
                initTable();
            }
            table.setData(json.data);
            loadingEl.style.display = 'none';
        } catch (err) {
            console.error('Failed to load containers:', err);
            loadingEl.innerHTML = '<span class="text-error">Failed to load - ' +
                '<button class="btn btn-xs btn-ghost" onclick="location.reload()">Retry</button></span>';
        }
    }

    // Handle check tags button click
    async function handleCheckClick(e) {
        const btn = e.target.closest('.check-tags-btn');
        if (!btn) return;

        const stack = btn.dataset.stack;
        const service = btn.dataset.service;
        const cell = btn.parentElement;

        cell.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';

        try {
            const resp = await fetch(`/api/containers/${stack}/${service}/tags`);
            cell.innerHTML = await resp.text();
        } catch (err) {
            cell.innerHTML = `<span class="badge badge-error">Error</span>`;
        }
    }

    // Check all tags
    const checkAllBtnOriginalHTML = checkAllBtn.innerHTML;
    async function checkAllTags() {
        const buttons = tableEl.querySelectorAll('.check-tags-btn');
        checkAllBtn.disabled = true;
        checkAllBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Checking...';

        for (const btn of buttons) {
            btn.click();
            await new Promise(r => setTimeout(r, 200));
        }

        checkAllBtn.disabled = false;
        checkAllBtn.innerHTML = checkAllBtnOriginalHTML;
    }

    // Event listeners
    refreshBtn.addEventListener('click', loadData);
    checkAllBtn.addEventListener('click', checkAllTags);

    // Initial load
    loadData();
})();
</script>
{% endblock %}
